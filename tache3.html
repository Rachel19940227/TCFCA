<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TCFCA-EO Tache3</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="styles_tache.css">
</head>
<body>
    <div style="display: flex; align-items: center; justify-content: space-between;">
        <!-- 返回按钮 -->
        <button onclick="window.location.href='index.html'" style="margin-bottom: 20px; align-self: flex-start;">返回首页</button>
        <h1 style="flex-grow: 1; text-align: center; margin: 0;">tache3播放器</h1>
    </div>
    
    <div id="currentAudio">
        <p>当前播放：<span id="answerAudioName">-</span></p> <!-- 显示答案音频名称 -->
        <p>字幕内容：<span id="subtitleText">-</span></p>
        <p>翻译内容：<span id="translateText">-</span></p>
        <p>答案内容：<span id="answerText">-</span></p>
        <p>问题音频：<span id="audioName">-</span> <!-- 显示原音频名称 -->
            <button onclick="toggleMainAudio()" id="mainPlayBtn">播放问题</button>
        </p>
    </div>

    
    <div class="controls">
        <button onclick="playPrevious()">上一条</button>
        <button onclick="togglePlay()" id="playBtn">播放</button>
        <button onclick="playNext()">下一条</button>
    </div>

    
    <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
        <div class="progress-thumb" id="progressThumb"></div>
    </div>
    
    <p>播放时间：<span id="currentTime">0:00</span> / <span id="duration">0:00</span></p>

    <script>
        // 初始化Supabase
        const supabase = window.supabase.createClient(
            'https://ljcnyljxxrnzqflvumcv.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxqY255bGp4eHJuenFmbHZ1bWN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE5NTg2NDksImV4cCI6MjA1NzUzNDY0OX0.q5LzNGG1yqHM01RYpoSmOuN4DCV5Vd_ksTTNPbni7JA'
        );

        let audioList = []; // 存储音频列表
        let currentIndex = 0; // 当前播放索引
        let isInitialized = false; // 新增初始化状态标识
        let autoPlayTimeout = null;
        let currentAnswerIndex = -1; // 跟踪当前答案音频索引
        let answerAbortController = new AbortController();
        let isAnswerLoading = false;
        const mainAudioElement = new Audio(); // 原answerAudioElement改为播放主内容
        const questionAudioElement = new Audio(); // 原audioElement改为播放问题音频

        // 修改初始化函数
        async function init() {
            try {
                const { data, error } = await supabase
                    .from('subtitles')
                    .select('*')
                    .order('id', { ascending: true });

                if (error) throw error;
                
                audioList = data;
                isInitialized = true;
                
                if (audioList.length > 0) {
                    loadAnswerAudio(currentIndex); // 改为加载答案音频
                }
            } catch (err) {
                console.error('初始化失败:', err);
            }
        }

async function loadAnswerAudio(index) {
    // 重置进度条状态
    progressBar.style.width = '0%';
    progressThumb.style.left = '0%';
    document.getElementById('currentTime').textContent = '0:00';
    document.getElementById('duration').textContent = '0:00';

    const audioInfo = audioList[index];
    
    // 更新界面显示
    document.getElementById('answerAudioName').textContent = audioInfo.answer_name || '无答案音频';
    document.getElementById('subtitleText').textContent = audioInfo.text || '无字幕内容';
    document.getElementById('translateText').textContent = audioInfo.translate || '无翻译内容';
    document.getElementById('answerText').textContent = audioInfo.answer || '无答案内容';
    document.getElementById('audioName').textContent = audioInfo.audio_name || '无问题音频';

    // 重置播放状态
    document.getElementById('playBtn').textContent = '播放';

    // 加载答案音频（主控音频）
    try {
        mainAudioElement.pause();
        const audioUrl = `${supabase.storageUrl}/object/public/audio/${encodeURIComponent(audioInfo.answer_name)}`;
        mainAudioElement.src = audioUrl;
        await mainAudioElement.load();
        
        // 加载完成后重置持续时间显示
        document.getElementById('duration').textContent = formatTime(mainAudioElement.duration);
    } catch (err) {
        console.error('答案音频加载失败:', err);
    }

    // 预加载问题音频
    try {
        questionAudioElement.pause();
        const questionUrl = `${supabase.storageUrl}/object/public/audio/${encodeURIComponent(audioInfo.audio_name)}`;
        questionAudioElement.src = questionUrl;
        await questionAudioElement.load();
    } catch (err) {
        console.error('问题音频加载失败:', err);
    }
}

        // 修改控制函数
        function togglePlay() {
            if (mainAudioElement.paused) {
                mainAudioElement.play();
                document.getElementById('playBtn').textContent = '暂停';
            } else {
                mainAudioElement.pause();
                document.getElementById('playBtn').textContent = '播放';
            }
        }

        // 修改问题音频播放函数
        function toggleMainAudio() {
            if (questionAudioElement.paused) {
                mainAudioElement.pause();
                questionAudioElement.play();
            } else {
                questionAudioElement.pause();
            }
        }


                // 获取进度条元素
                const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressThumb = document.getElementById('progressThumb');
        
        // 拖拽状态变量
        let isDragging = false;
        
        // 点击进度条跳转
        progressContainer.addEventListener('click', (e) => {
            if (!mainAudioElement.duration) return;
            
            const rect = progressContainer.getBoundingClientRect();
            const pos = (e.clientX - rect.left) / rect.width;
            mainAudioElement.currentTime = pos * mainAudioElement.duration;
        });

        // 拖拽功能实现
        progressThumb.addEventListener('mousedown', startDrag);
        progressContainer.addEventListener('mousedown', startDrag);

        document.addEventListener('mousemove', handleDrag);
        document.addEventListener('mouseup', endDrag);

        // 移动端支持
        progressThumb.addEventListener('touchstart', startDrag);
        progressContainer.addEventListener('touchstart', startDrag);
        document.addEventListener('touchmove', handleDrag);
        document.addEventListener('touchend', endDrag);

        function startDrag(e) {
            isDragging = true;
            mainAudioElement.pause();
            handleDrag(e);
        }

        function handleDrag(e) {
            if (!isDragging) return;
            
            const rect = progressContainer.getBoundingClientRect();
            const clientX = e.clientX || (e.touches && e.touches[0].clientX);
            
            if (!clientX) return;
            
            let pos = (clientX - rect.left) / rect.width;
            pos = Math.max(0, Math.min(1, pos));
            
            const currentTime = pos * mainAudioElement.duration;
            
            // 更新显示
            progressBar.style.width = `${pos * 100}%`;
            progressThumb.style.left = `${pos * 100}%`;
            document.getElementById('currentTime').textContent = formatTime(currentTime);
            
            // 实时更新音频时间（但不立即设置，等待拖动结束）
            if (!e.type.includes('touch')) {
                e.preventDefault();
            }
        }

        function endDrag(e) {
            if (!isDragging) return;
            isDragging = false;
            
            const rect = progressContainer.getBoundingClientRect();
            const clientX = e.clientX || (e.changedTouches && e.changedTouches[0].clientX);
            
            if (clientX) {
                const pos = (clientX - rect.left) / rect.width;
                mainAudioElement.currentTime = Math.max(0, Math.min(mainAudioElement.duration, pos * mainAudioElement.duration));
            }
            
            mainAudioElement.play();
        }

        // 修改进度条和时间更新
        mainAudioElement.addEventListener('timeupdate', () => {
            if (isDragging) return;   
            const progress = (mainAudioElement.currentTime / mainAudioElement.duration) * 100;
            progressBar.style.width = `${progress}%`;
            progressThumb.style.left = `${progress}%`;
            document.getElementById('progressBar').style.width = `${progress}%`;
            
            document.getElementById('currentTime').textContent = 
                formatTime(mainAudioElement.currentTime);
            document.getElementById('duration').textContent = 
                formatTime(mainAudioElement.duration);
        });

        // 确保音频加载后显示滑块
        mainAudioElement.addEventListener('loadedmetadata', () => {
            progressThumb.style.display = 'block';
        });

        // 修改播放结束事件监听
        mainAudioElement.addEventListener('ended', () => {
            // 重置进度条
            progressBar.style.width = '0%';
            progressThumb.style.left = '0%';
            document.getElementById('currentTime').textContent = '0:00';
            playNext();
        });


// 修改切换条目函数
function playPrevious() {
    if (!isInitialized) return;
    currentIndex = Math.max(0, currentIndex - 1);
    loadAnswerAudio(currentIndex);
}

async function playNext() {
    if (!isInitialized) return;
    currentIndex = Math.min(audioList.length - 1, currentIndex + 1);
    await loadAnswerAudio(currentIndex);
}

        // 更新初始化调用
        init().then(() => {
            if (audioList.length === 0) {
                alert('没有可播放的音频');
            } else {
                mainAudioElement.addEventListener('ended', playNext);
            }
        });



        // 时间格式化函数
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            seconds = Math.floor(seconds % 60);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

    </script>
</body>
</html>