<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TCFCA-EO Tache3</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="styles_tache.css">
</head>
<body>
    <div style="display: flex; align-items: center; justify-content: space-between;">
        <!-- 返回按钮 -->
        <button onclick="window.location.href='index.html'" style="margin-bottom: 20px; align-self: flex-start;">返回首页</button>
        <h1 style="flex-grow: 1; text-align: center; margin: 0;">tache3播放器</h1>
    </div>
    
    <div id="currentAudio">
        <p>当前播放：<span id="answerAudioName">-</span></p> <!-- 显示答案音频名称 -->
        <p>字幕内容：<span id="subtitleText">-</span></p>
        <p>翻译内容：<span id="translateText">-</span></p>
        <p>答案内容：<span id="answerText">-</span></p>
        <p>问题音频：<span id="audioName">-</span> <!-- 显示原音频名称 -->
            <button onclick="toggleMainAudio()" id="mainPlayBtn">播放问题</button>
        </p>
    </div>

    
    <div class="controls">
        <button onclick="playPrevious()">上一条</button>
        <button onclick="togglePlay()" id="playBtn">播放</button>
        <button onclick="playNext()">下一条</button>
    </div>

    
    <div class="progress">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    
    <p>播放时间：<span id="currentTime">0:00</span> / <span id="duration">0:00</span></p>

    <script>
        // 初始化Supabase
        const supabase = window.supabase.createClient(
            'https://ljcnyljxxrnzqflvumcv.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxqY255bGp4eHJuenFmbHZ1bWN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE5NTg2NDksImV4cCI6MjA1NzUzNDY0OX0.q5LzNGG1yqHM01RYpoSmOuN4DCV5Vd_ksTTNPbni7JA'
        );

        let audioList = []; // 存储音频列表
        let currentIndex = 0; // 当前播放索引
        let isInitialized = false; // 新增初始化状态标识
        let autoPlayTimeout = null;
        let currentAnswerIndex = -1; // 跟踪当前答案音频索引
        let answerAbortController = new AbortController();
        let isAnswerLoading = false;
        const mainAudioElement = new Audio(); // 原answerAudioElement改为播放主内容
        const questionAudioElement = new Audio(); // 原audioElement改为播放问题音频

        // 修改初始化函数
        async function init() {
            try {
                const { data, error } = await supabase
                    .from('subtitles')
                    .select('*')
                    .order('id', { ascending: true });

                if (error) throw error;
                
                audioList = data;
                isInitialized = true;
                
                if (audioList.length > 0) {
                    loadAnswerAudio(currentIndex); // 改为加载答案音频
                }
            } catch (err) {
                console.error('初始化失败:', err);
            }
        }

        async function loadAnswerAudio(index) {
            const audioInfo = audioList[index];
            
            // 更新界面显示
            document.getElementById('answerAudioName').textContent = audioInfo.answer_name || '无答案音频';
            document.getElementById('subtitleText').textContent = audioInfo.text || '无字幕内容';
            document.getElementById('translateText').textContent = audioInfo.translate || '无翻译内容';
            document.getElementById('answerText').textContent = audioInfo.answer || '无答案内容';
            document.getElementById('audioName').textContent = audioInfo.audio_name || '无问题音频';

            // 加载答案音频（主控音频）
            try {
                mainAudioElement.pause();
                const audioUrl = `${supabase.storageUrl}/object/public/audio/${encodeURIComponent(audioInfo.answer_name)}`;
                mainAudioElement.src = audioUrl;
                await mainAudioElement.load();
            } catch (err) {
                console.error('答案音频加载失败:', err);
            }

            // 预加载问题音频
            try {
                questionAudioElement.pause();
                const questionUrl = `${supabase.storageUrl}/object/public/audio/${encodeURIComponent(audioInfo.audio_name)}`;
                questionAudioElement.src = questionUrl;
                await questionAudioElement.load();
            } catch (err) {
                console.error('问题音频加载失败:', err);
            }
        }

        // 修改控制函数
        function togglePlay() {
            if (mainAudioElement.paused) {
                mainAudioElement.play();
                document.getElementById('playBtn').textContent = '暂停';
            } else {
                mainAudioElement.pause();
                document.getElementById('playBtn').textContent = '播放';
            }
        }

        // 修改问题音频播放函数
        function toggleMainAudio() {
            if (questionAudioElement.paused) {
                mainAudioElement.pause();
                questionAudioElement.play();
            } else {
                questionAudioElement.pause();
            }
        }

        // 修改进度条和时间更新
        mainAudioElement.addEventListener('timeupdate', () => {
            const progress = (mainAudioElement.currentTime / mainAudioElement.duration) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            
            document.getElementById('currentTime').textContent = 
                formatTime(mainAudioElement.currentTime);
            document.getElementById('duration').textContent = 
                formatTime(mainAudioElement.duration);
        });

        
        // 修改进度条和时间更新
        mainAudioElement.addEventListener('timeupdate', () => {
            const progress = (mainAudioElement.currentTime / mainAudioElement.duration) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            
            document.getElementById('currentTime').textContent = 
                formatTime(mainAudioElement.currentTime);
            document.getElementById('duration').textContent = 
                formatTime(mainAudioElement.duration);
        });

        // 修改切换条目函数
        function playPrevious() {
            if (!isInitialized) return;
            currentIndex = Math.max(0, currentIndex - 1);
            loadAnswerAudio(currentIndex);
        }

        async function playNext() {
            if (!isInitialized) return;
            currentIndex = Math.min(audioList.length - 1, currentIndex + 1);
            await loadAnswerAudio(currentIndex);
        }

        // 更新初始化调用
        init().then(() => {
            if (audioList.length === 0) {
                alert('没有可播放的音频');
            } else {
                mainAudioElement.addEventListener('ended', playNext);
            }
        });



        // 时间格式化函数
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            seconds = Math.floor(seconds % 60);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

    </script>
</body>
</html>